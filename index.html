<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Wikipedia Summarizer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Wikipedia Summarizer</h1>
            <p>Intelligent summaries from Wikipedia articles</p>
        </header>

        <main class="main-content">
            <div class="input-section">
                <form id="summarizerForm">
                    <div class="url-inputs-container" id="urlInputsContainer">
                        <div class="url-input-row">
                            <input type="url" class="url-input multiple-url" placeholder="Enter Wikipedia article URL" required>
                            <button type="button" class="add-url-btn" id="addUrlBtn" onclick="addUrlInput()">+ Add More</button>
                        </div>
                    </div>
                    
                    <div class="submit-section">
                        <button type="submit" class="submit-btn" id="submitBtn">
                            <span id="submitText">Summarize</span>
                        </button>
                    </div>
                </form>
            </div>

            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>Generating summary...</p>
            </div>

            <div class="result-section" id="result">
                <article class="summary-article">
                    <header class="summary-header">
                        <h2 id="summaryTitle">Article Summary</h2>
                        <div class="summary-meta">
                            <span id="readingTime"></span>
                        </div>
                    </header>
                    
                    <div class="summary-content" id="summaryText"></div>
                    
                    <footer class="summary-footer">
                        <div class="source-link" id="sourceLink"></div>
                        <button class="copy-btn" id="copyBtn">Copy text</button>
                    </footer>
                </article>
            </div>

            <div class="error" id="error">
                <p id="errorMessage"></p>
            </div>
        </main>
    </div>

    <div id="toast" class="toast">Text copied!</div>

    <script>
        let currentSummaryLength = 'long';

        // DOM Elements
        const form = document.getElementById('summarizerForm');
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.getElementById('submitText');
        const urlInputsContainer = document.getElementById('urlInputsContainer');
        const addUrlBtn = document.getElementById('addUrlBtn');
        const loading = document.getElementById('loading');
        const result = document.getElementById('result');
        const error = document.getElementById('error');
        const summaryText = document.getElementById('summaryText');
        const summaryTitle = document.getElementById('summaryTitle');
        const readingTime = document.getElementById('readingTime');
        const sourceLink = document.getElementById('sourceLink');
        const copyBtn = document.getElementById('copyBtn');
        const toast = document.getElementById('toast');

        // Initialize
        document.addEventListener('DOMContentLoaded', setupEventListeners);

        function setupEventListeners() {
            // Form submission
            form.addEventListener('submit', handleSubmit);

            // Copy button
            copyBtn.addEventListener('click', copySummary);
        }

        function addUrlInput() {
            const container = urlInputsContainer;
            const currentInputs = container.querySelectorAll('.url-input-row');
            
            if (currentInputs.length >= 10) {
                showError('Maximum 10 URLs allowed');
                return;
            }

            const newRow = document.createElement('div');
            newRow.className = 'url-input-row';
            newRow.innerHTML = `
                <input type="url" class="url-input multiple-url" placeholder="Wikipedia article URL #${currentInputs.length + 1}" required>
                <button type="button" class="remove-url-btn" onclick="removeUrlInput(this)">×</button>
            `;
            
            container.appendChild(newRow);
            
            // Update the first row to show remove button if this is the second URL
            if (currentInputs.length === 1) {
                const firstRow = currentInputs[0];
                const firstAddBtn = firstRow.querySelector('.add-url-btn');
                if (firstAddBtn) {
                    firstAddBtn.remove();
                    // Create and append the remove button instead of using innerHTML +=
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'remove-url-btn';
                    removeBtn.onclick = function() { removeUrlInput(this); };
                    removeBtn.textContent = '×';
                    firstRow.appendChild(removeBtn);
                }
            }
            
            // Hide add button if we've reached the maximum
            if (container.querySelectorAll('.url-input-row').length >= 10) {
                // Move add button to the bottom instead of hiding
                updateAddButtonPosition();
            }
        }

        function removeUrlInput(button) {
            const row = button.parentElement;
            const container = urlInputsContainer;
            const rows = container.querySelectorAll('.url-input-row');
            
            // Don't allow removing if only 1 row remains
            if (rows.length <= 1) {
                return;
            }
            
            row.remove();
            
            // If only one row left, replace remove button with add button
            const remainingRows = container.querySelectorAll('.url-input-row');
            if (remainingRows.length === 1) {
                const lastRow = remainingRows[0];
                const removeBtn = lastRow.querySelector('.remove-url-btn');
                if (removeBtn) {
                    removeBtn.remove();
                    // Create and append the add button instead of using innerHTML +=
                    const addBtn = document.createElement('button');
                    addBtn.type = 'button';
                    addBtn.className = 'add-url-btn';
                    addBtn.onclick = addUrlInput;
                    addBtn.textContent = '+ Add More';
                    lastRow.appendChild(addBtn);
                }
            }
            
            // Update placeholders
            remainingRows.forEach((row, index) => {
                const input = row.querySelector('.multiple-url');
                if (remainingRows.length === 1) {
                    input.placeholder = 'Enter Wikipedia article URL';
                } else {
                    input.placeholder = `Wikipedia article URL #${index + 1}`;
                }
            });
        }

        function updateAddButtonPosition() {
            // This function can be used to move add button to bottom when needed
            const container = urlInputsContainer;
            const addBtn = container.querySelector('.add-url-btn');
            if (addBtn) {
                addBtn.remove();
            }
            
            // Add a separate add button below all inputs
            const submitSection = document.querySelector('.submit-section');
            if (!document.querySelector('.add-more-btn')) {
                const newAddBtn = document.createElement('button');
                newAddBtn.type = 'button';
                newAddBtn.className = 'add-url-btn add-more-btn';
                newAddBtn.onclick = addUrlInput;
                newAddBtn.textContent = '+ Add More URLs';
                submitSection.insertBefore(newAddBtn, submitBtn);
            }
        }

        function isValidWikipediaUrl(url) {
            try {
                const urlObj = new URL(url);
                return urlObj.hostname.includes('wikipedia.org') && urlObj.pathname.includes('/wiki/');
            } catch {
                return false;
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();
            
            const urlInputs = document.querySelectorAll('.multiple-url');
            const urls = Array.from(urlInputs)
                .map(input => input.value.trim())
                .filter(url => url); // Remove empty values
            
            if (urls.length === 0) {
                showError('Please enter at least one Wikipedia article URL');
                return;
            }

            // Validate all URLs
            const invalidUrls = urls.filter(url => !isValidWikipediaUrl(url));
            if (invalidUrls.length > 0) {
                showError(`Please check that all URLs are valid Wikipedia articles. ${invalidUrls.length} invalid URL(s) found.`);
                return;
            }

            showLoading();
            hideError();
            hideResult();

            try {
                if (urls.length === 1) {
                    // Handle single URL
                    const response = await fetch('/api/summarize', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            url: urls[0],
                            length: currentSummaryLength 
                        })
                    });
                    
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to generate summary');
                    }

                    displaySummary(data.summary, data.title, urls[0]);
                } else {
                    // Handle multiple URLs
                    const response = await fetch('/api/summarize-multiple', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            urls: urls,
                            length: currentSummaryLength 
                        })
                    });
                    
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to generate summary');
                    }

                    displayMultipleSummary(data);
                }

                hideLoading();

            } catch (err) {
                showError(err.message);
                hideLoading();
            }
        }

        function displaySummary(summary, title, url) {
            // Set title
            summaryTitle.textContent = title;
            
            // Format and display content
            summaryText.innerHTML = formatSummary(summary);
            
            // Calculate reading time
            const words = summary.split(/\s+/).length;
            const readingTimeMin = Math.ceil(words / 200);
            readingTime.textContent = `${readingTimeMin} min read`;
            
            // Add source link
            sourceLink.innerHTML = `<a href="${url}" target="_blank">View original article</a>`;
            
            // Store for copying
            window.currentSummary = summary;
            
            showResult();
        }

        function displayMultipleSummary(data) {
            // Set title with multiple articles
            const titleText = data.titles.length > 3 
                ? `${data.titles.slice(0, 3).join(', ')} and ${data.titles.length - 3} more articles`
                : data.titles.join(', ');
            summaryTitle.textContent = `Combined Summary: ${titleText}`;
            
            // Format and display content
            summaryText.innerHTML = formatSummary(data.summary);
            
            // Calculate reading time
            const words = data.wordCount || data.summary.split(/\s+/).length;
            const readingTimeMin = Math.ceil(words / 200);
            readingTime.textContent = `${readingTimeMin} min read`;
            
            // Add source links
            const sourceLinks = data.urls.map((url, index) => 
                `<a href="${url}" target="_blank">${data.titles[index]}</a>`
            ).join(' • ');
            
            let sourceLinkHtml = `<div class="multiple-sources">
                <strong>Sources (${data.successCount}/${data.totalCount} articles):</strong><br>
                ${sourceLinks}
            </div>`;
            
            // Add warnings if any articles failed
            if (data.warnings && data.warnings.length > 0) {
                sourceLinkHtml += `<div class="warnings">
                    <strong>Note:</strong> ${data.totalCount - data.successCount} article(s) could not be processed
                </div>`;
            }
            
            sourceLink.innerHTML = sourceLinkHtml;
            
            // Store for copying
            window.currentSummary = data.summary;
            
            showResult();
        }

        function formatSummary(summary) {
            // Comprehensive markdown-to-HTML conversion for readability
            let formatted = summary
                // Convert headers (## Title)
                .replace(/^### (.+)$/gm, '<h4 class="sub-section-title">$1</h4>')
                .replace(/^## (.+)$/gm, '<h3 class="section-title">$1</h3>')
                .replace(/^# (.+)$/gm, '<h2 class="main-title">$1</h2>')
                
                // Convert bold text (**text** and __text__)
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/__(.*?)__/g, '<strong>$1</strong>')
                
                // Convert italic text (*text* and _text_)
                .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                .replace(/_([^_]+)_/g, '<em>$1</em>')
                
                // Convert inline code (`code`)
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                
                // Convert links [text](url)
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
                
                // Convert bullet points (•, -, *, +)
                .replace(/^[•\-\*\+]\s+(.+)$/gm, '<li>$1</li>')
                
                // Convert numbered lists (1. item, 2. item, etc.)
                .replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>')
                
                // Convert blockquotes (> text)
                .replace(/^>\s+(.+)$/gm, '<blockquote>$1</blockquote>')
                
                // Convert horizontal rules (--- or ***)
                .replace(/^[\-\*]{3,}$/gm, '<hr>');

            // Handle tables
            formatted = parseMarkdownTables(formatted);

            // Split into paragraphs and process
            formatted = formatted
                .split('\n\n')
                .map(paragraph => {
                    paragraph = paragraph.trim();
                    if (!paragraph) return '';
                    
                    // Don't wrap already formatted elements
                    if (paragraph.match(/^<(h[1-6]|ul|ol|li|blockquote|hr|div|table)/)) {
                        return paragraph;
                    }
                    
                    // Handle list items specially
                    if (paragraph.includes('<li>')) {
                        return paragraph;
                    }
                    
                    // Wrap regular text in paragraph tags
                    return `<p>${paragraph}</p>`;
                })
                .join('\n\n');

            // Wrap consecutive list items in ul tags
            formatted = formatted.replace(/(<li>.*?<\/li>\s*)+/gs, (match) => {
                return `<ul>${match.trim()}</ul>`;
            });
            
            // Clean up multiple consecutive line breaks
            formatted = formatted.replace(/\n{3,}/g, '\n\n');
            
            return formatted;
        }

        function parseMarkdownTables(text) {
            // Match markdown table pattern
            const tableRegex = /(\|[^\n]+\|\n)+(\|[\s\-:]*\|\n)?(\|[^\n]+\|\n)*/g;
            
            return text.replace(tableRegex, (match) => {
                const lines = match.trim().split('\n');
                if (lines.length < 2) return match;
                
                // Find header separator line (contains dashes)
                let headerIndex = -1;
                let separatorIndex = -1;
                
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('-') && lines[i].includes('|')) {
                        separatorIndex = i;
                        headerIndex = i - 1;
                        break;
                    }
                }
                
                if (headerIndex === -1 || separatorIndex === -1) return match;
                
                // Parse header
                const headerCells = lines[headerIndex]
                    .split('|')
                    .filter(cell => cell.trim())
                    .map(cell => `<th>${cell.trim()}</th>`);
                
                // Parse body rows
                const bodyRows = lines.slice(separatorIndex + 1)
                    .map(line => {
                        const cells = line
                            .split('|')
                            .filter(cell => cell.trim())
                            .map(cell => `<td>${cell.trim()}</td>`);
                        return `<tr>${cells.join('')}</tr>`;
                    });
                
                return `<div class="table-container">
                    <table class="summary-table">
                        <thead>
                            <tr>${headerCells.join('')}</tr>
                        </thead>
                        <tbody>
                            ${bodyRows.join('')}
                        </tbody>
                    </table>
                </div>`;
            });
        }

        function copySummary() {
            if (window.currentSummary) {
                navigator.clipboard.writeText(window.currentSummary).then(() => {
                    showToast('Text copied to clipboard!');
                }).catch(() => {
                    showToast('Failed to copy text');
                });
            }
        }

        function showLoading() {
            loading.style.display = 'flex';
            submitBtn.disabled = true;
            submitText.textContent = 'Processing...';
        }

        function hideLoading() {
            loading.style.display = 'none';
            submitBtn.disabled = false;
            submitText.textContent = 'Summarize';
        }

        function showResult() {
            result.style.display = 'block';
            setTimeout(() => {
                result.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        function hideResult() {
            result.style.display = 'none';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            error.style.display = 'block';
            setTimeout(() => {
                error.style.display = 'none';
            }, 5000);
        }

        function hideError() {
            error.style.display = 'none';
        }

        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }
    </script>
</body>
</html>